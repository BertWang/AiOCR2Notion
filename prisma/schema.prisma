// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. 資料夾/專案 (用於分類筆記)
model Collection {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String   // 多用戶擴充預留 (目前可設為 default "user")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  notes       Note[]   // 關聯：一個資料夾有多個筆記
}

// 2. 筆記本體
model Note {
  id             String   @id @default(cuid())

  // 檔案資訊
  imageUrl       String   // 圖片存放路徑 (如果是本地開發，可能是 public/uploads/...)
  fileKey        String?  // 用於雲端儲存的 Key (選配)

  // A. 第一階段：原始辨識 (OCR)
  rawOcrText     String?  // 原始 OCR 結果 (尚未清理，可能含錯字)
  ocrProvider    String?  // 例如: "gemini-flash", "tesseract", "azure"
  
  // B. 第二階段：語意清理與核對 (AI Cleaning)
  refinedContent String?  // 經 AI 修正錯別字、手寫誤判後的最終 Markdown
  confidence     Float?   // AI 對辨識結果的信心分數 (0.0 - 1.0)
  
  // C. 第三階段：歸檔 (Classification)
  summary        String?  // AI 自動生成的摘要
  tags           String?   // 標籤 (SQLite 不支援 String[]，使用逗號分隔字串儲存，如 "tag1,tag2")

  // 狀態管理
  status         String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorMessage   String?  // 若失敗，記錄原因

  // 關聯
  collectionId   String?
  collection     Collection? @relation(fields: [collectionId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// 3. 管理員設定與整合
model AdminSettings {
  id          String   @id @default("singleton")
  aiProvider  String   @default("gemini-2.0-flash") // e.g. gemini, openai, azure
  modelName   String   @default("gemini-2.0-flash")
  config      String?  // provider specific configuration serialized as JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Integration {
  id         String   @id @default(cuid())
  provider   String   // e.g. "mcp", "notion"
  enabled    Boolean  @default(false)
  config     String?  // provider specific config serialized as JSON string
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// 4. 搜尋歷史 (Search History)
model SearchHistory {
  id        String   @id @default(cuid())
  query     String   // 搜尋查詢字符串
  filters   String?  // JSON 格式的篩選條件 (dateFrom, dateTo, status, etc.)
  resultCount Int    @default(0) // 返回結果數量
  userId    String?  // 用戶 ID (多用戶支援預留)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId, createdAt])
}

// 5. 保存的搜尋 (Saved Searches)
model SavedSearch {
  id          String   @id @default(cuid())
  name        String   // 保存搜尋的名稱 (例如: "重要筆記", "本月工作")
  query       String   // 搜尋查詢字符串
  filters     String?  // JSON 格式的篩選條件
  description String?  // 搜尋描述
  userId      String?  // 用戶 ID (多用戶支援預留)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}

// 6. AI 聊天訊息 (Chat Messages)
model ChatMessage {
  id        String   @id @default(cuid())
  noteId    String   // 關聯的筆記 ID
  role      String   // "user" 或 "assistant"
  content   String   // 訊息內容
  tokens    Int?     // 使用的 token 數量 (用於計費)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([noteId, createdAt])
}
